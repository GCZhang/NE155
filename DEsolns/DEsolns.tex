%--------------------------------------------------------------------
% NE 155 (intro to numerical simulation of radiation transport)
% Spring 2014

% formatting
\documentclass[12pt]{article}
\usepackage[top=1in, bottom=1in, left=1in, right=1in]{geometry}

\usepackage{setspace}
\onehalfspacing

\setlength{\parindent}{0mm} \setlength{\parskip}{1em}


% packages
\usepackage{amssymb}
%% The amsthm package provides extended theorem environments
\usepackage{amsthm}
\usepackage{epsfig}
\usepackage{times}
\renewcommand{\ttdefault}{cmtt}
\usepackage{amsmath}
\usepackage{graphicx} % for graphics files

% Draw figures yourself
\usepackage{tikz} 

% The float package HAS to load before hyperref
\usepackage{float} % for psuedocode formatting
\usepackage{xspace}

% from Denovo methods manual
\usepackage{mathrsfs}
\usepackage[mathcal]{euscript}
\usepackage{color}
\usepackage{array}

\usepackage[pdftex]{hyperref}

\newcommand{\nth}{n\ensuremath{^{\text{th}}} }
\newcommand{\ve}[1]{\ensuremath{\mathbf{#1}}}
\newcommand{\macro}{\ensuremath{\Sigma}}
\newcommand{\vOmega}{\ensuremath{\hat{\Omega}}}

\newcommand{\cc}[1]{\ensuremath{\overline{#1}}}
\newcommand{\ccm}[1]{\ensuremath{\overline{\mathbf{#1}}}}


%--------------------------------------------------------------------
%--------------------------------------------------------------------
\begin{document}
\begin{center}
{\bf NE 155, Classes 21-23, S14 \\
Finite Difference Methods for the DE \\ March 12-17, 2014}
\end{center}

\setlength{\unitlength}{1in}
\begin{picture}(6,.1) 
\put(0,0) {\line(1,0){6.25}}         
\end{picture}

%--------------------------------------------------------------------
\section{Finite-Difference Method}
\underline{Problem} Consider the following second order ODE:
\[f''(x) = p(x)f'(x) + q(x)f(x) + r(x)\]
%
defined on a segment $[a,b]$ with $f(a) = \alpha$ and $f(b) = \beta$ (a boundary value problem).  

Now, let's spatially discretize the equation:
%
\begin{center}
\begin{tikzpicture}
\draw (-.25,0)--(1.25,0);
\draw[dotted] (1.25,0)--(2.75,0);
\draw (2.75,0)--(5.25,0);
\draw[dotted] (5.25,0)--(6.75,0);
\draw (6.75,0)--(8.25,0);
%\draw (4,0)--(5.25,0);
\draw (0,-.25)--(0,.25);
\draw (1,-.25)--(1,.25);
%\draw (2,-.25)--(2,.25);
\draw (3,-.25)--(3,.25);
\draw (4,-.25)--(4,.25);
\draw (5,-.25)--(5,.25);
\draw (7,-.25)--(7,.25);
\draw (8,-.25)--(8,.25);
\node[below] at (0,-.25) {$x_0 = a$};
\node[below] at (1,-.25) {$x_1$};
\node[below] at (3,-.25) {$x_{i-1}$};
\node[below] at (4,-.25) {$x_i$};
\node[below] at (5,-.25) {$x_{i+1}$};
\node[below] at (7,-.25) {$x_{n-1}$};
\node[below] at (8,-.25) {$x_n = b$};
\node[above] at (0.5, 0.5) {$h$};
\node[above] at (3.5, 0.5) {$h$};
\end{tikzpicture}
\end{center}
%
where $x_0 = a$, $x_n = b$, and $h$ is the mesh spacing. There are $n+1$ points and $n$ mesh cells.

We can use \textbf{central difference} to approximate the derivatives on this grid. Let's use the $O(h^2)$ versions:
%
\begin{align}
f'(x_i) &= \frac{f(x_i + h) - f(x_i - h)}{2h} - \frac{h^2}{6} f'''(\mu) \nonumber \\
%
f''(x_i) &= \frac{f(x_i + h) - 2f(x_i) + f(x_i - h)}{h^2} + \frac{h^2}{12}f^{(4)}(\mu) \nonumber
\end{align}
%
We will also define $p_i = p(x_i)$, $q_i = q(x_i)$, $r_i = r(x_i)$.

Substituting into the original equation, we get:
\begin{align}
\frac{f_{i+1} - 2f_i + f_{i-1}}{h^2} &= p_i \frac{f_{i+1} - f_{i-1}}{2h} + q_i f_i + r_i \qquad i = 1, 2, \dots, n-1 \nonumber \\
%
\bigl(\frac{-h}{2}p_i - 1\bigr) f_{i-1} &+ \bigl(2 + h^2q_i\bigr)f_i + \bigl(\frac{h}{2}p_i - 1\bigr) f_{i+1} = -h^2 r_i \qquad i = 1, 2, \dots, n-1 \nonumber
\end{align}

We only have $n-1$ equations, but because the boundaries are fixed that is all we need. This is clear when we look at the $i=1$ and $i=n-1$ cases:
\begin{align}
&\bigl(2 + h^2q_1\bigr)f_1 + \bigl(\frac{h}{2}p_1 - 1\bigr) f_{2} = -h^2 r_1 + \underbrace{\bigl(\frac{h}{2}p_1 + 1\bigr) \underbrace{\alpha}_{f_0}}_{bc_L} \nonumber \\
 %
&\bigl(\frac{-h}{2}p_{n-1} - 1\bigr) f_{n-2} + \bigl(2 + h^2q_{n-1}\bigr)f_{n-1} = -h^2 r_{n-1} + \underbrace{\bigl(\frac{-h}{2}p_{n-1} + 1\bigr) \underbrace{\beta}_{f_n}}_{bc_R} \nonumber
\end{align}

Thus, we can write this as a matrix equation:
\begin{equation}
\begin{pmatrix}
\bigl(2 + h^2q_1\bigr) & \bigl(\frac{h}{2}p_1 - 1\bigr) & & \hdots & 0 \\
%
\bigl(\frac{-h}{2}p_2 - 1\bigr) & \bigl(2 + h^2q_2\bigr) & \bigl(\frac{h}{2}p_2 - 1\bigr) & &  \\
\vdots & \ddots & \ddots & \ddots & \vdots \\
& & \bigl(\frac{-h}{2}p_{n-2} - 1\bigr) & \bigl(2 + h^2q_{n-2}\bigr)  & \bigl(\frac{h}{2}p_{n-2} - 1\bigr) \\
0 & \hdots & & \bigl(\frac{-h}{2}p_{n-1} - 1\bigr) & \bigl(2 + h^2q_{n-1}\bigr) \\
\end{pmatrix}
%
\begin{pmatrix}
f_1 \\ f_2 \\ \vdots \\ f_{n-2} \\ f_{n-1} \\
\end{pmatrix}
= 
\begin{pmatrix}
-h^2 r_1 + bc_L \\ -h^2 r_2 \\ \vdots \\ -h^2 r_{n-1} \\ -h^2 r_{n-1} + bc_R\\ 
\end{pmatrix}\nonumber
\end{equation}


Note: the numerical solution to the PDE is an approximation to the exact solution that is obtained using a discrete representation of the PDE at the grid points $x_i$ in the discrete spatial mesh. Let us denote this numerical solution as $F$ such that 
$$F_j \approx f(x_j)$$ 

Thus, the numerical solution is a collection of finite values
$$F = [F_1, F_2, \dots, F_{n-1}]$$
and we have boundary values $F_0$ and $F_n$.


%---------------------------------------------
\subsection{DE}
What does this look like if we apply it to the steady state 1-D diffusion equation?
\[-D\frac{d^2 \phi(x)}{dx^2} + \Sigma_a \phi(x) = S_0\]
\[\frac{d^2 \phi}{dx^2} - \frac{1}{L^2}\phi(x) = \frac{-S_0}{D}\]
and let $\phi(a) = \phi(b) = 0$ (vacuum bcs). Then we get
\begin{align}
\frac{\phi_{i+1} - 2\phi_i + \phi_{i-1}}{h^2} - \frac{1}{L^2}\phi_i &= \frac{-S_{0,i}}{D} \qquad i = 1, 2, \dots, n-1 \nonumber \\
%
-\phi_{i-1} &+ \bigl(2 + \frac{h^2}{L^2}\bigr)\phi_i - \phi_{i+1} = h^2 \frac{S_{0,i}}{D} \qquad i = 1, 2, \dots, n-1 \nonumber
\end{align}

One problem with this formulation is that we only have values at the cell edges: \underline{edge centered}. This really only works well when we have homogeneous media. Why might that be? If we have \textit{material discontinuities} it's going to be difficult to enforce flux continuity between cells. Note: $L$ and $D$ are not functions of space; we wouldn't know which cell's values to assign when using edge-centered values. 

What could we do instead? \underline{cell-centered}, which leads us to our next topic.


%-----------------------------------------------------
%-----------------------------------------------------
\section{Finite Volume Method}
Rather than pointwise approximations on a grid, FVM approximates an average integral value on a reference volume.

%
\begin{center}
\begin{tikzpicture}
\draw[dotted] (1.75,0)--(2.75,0);
\draw (2.75,0)--(5.25,0);
\draw[dotted] (5.25,0)--(6.25,0);
\draw (3,-.25)--(3,.25);
\draw (3.5,-.1)--(3.5,.1);
\draw (4,-.25)--(4,.25);
\draw (4.5,-.1)--(4.5,.1);
\draw (5,-.25)--(5,.25);
\node[below] at (3,-.25) {$x_{i-1}$};
\node[below] at (4,-.25) {$x_i$};
\node[below] at (5,-.25) {$x_{i+1}$};
\node[above] at (3.5, 0.25) {$x_{i-1/2}$};
\node[above] at (4.5, 0.25) {$x_{i+1/2}$};
\end{tikzpicture}
\end{center}

Consider the elliptic equation $f''(x) = r(x)$ on a control volume $V_i = [x_{i-1/2}, x_{i+1/2}]$, then
\[\int_{x_{i-1/2}}^{x_{i+1/2}} f''(x)dx = \int_{x_{i-1/2}}^{x_{i+1/2}} r(x) dx\]
%
We can evaluate the lhs analytically and the rhs using some integration rule. For simplicity, let's use the midpoint rule:
%
\[f'(x_{i+1/2}) - f'(x_{i-1/2}) = (x_{i+1/2} - x_{i+1/2})r_i\]
%
We can now use differencing schemes to represent the derivatives on the left. Define $h = x_{i+1/2} - x_{i-1/2}$
\[\frac{f_{i+1} - 2f_i + f_{i-1}}{h} = hr_i\]

This
\begin{itemize}
\item applies to the integral form of conservation laws (like the DE).
\item handles discontinuities in solution (because we're using cell-integrated values)
\item works well for heterogeneous systems because each cell can be a different material
\item there exists a theory for convergence, accuracy, and stability
\end{itemize}


%---------------------------------------------
\subsection{DE} 
What does this look like if we apply it to the steady state 1-D diffusion equation?
\[-\frac{d}{dx}D(x)\frac{d \phi(x)}{dx} + \Sigma_a(x) \phi(x) = S_0(x)\]
%
\begin{figure}[h!]
\includegraphics[height=1in]{FVM-fig}
\end{figure}
%
Let's also assume we have an equilibrium condition at the centerline ($x_0 = 0$) and vacuum on the right ($x_n = a$):
\begin{align}
\frac{d}{dx}\phi(x) \big|_{x=0} &= 0 \qquad \text{zero net current} \nonumber\\
\phi(\tilde{a}) &= 0 \qquad \tilde{a} = a + 2D \nonumber
\end{align}

We again have a spatial mesh, and material discontinuities will coincide with cell edges, $x_i$. Thus, we assume the cross section and diffusion coefficient are constant in each cell and the unknown fluxes and known sources are defined at the cell edges:
\begin{align}
D(x) &= D_i\;, \qquad x_{i-1} \leq x \leq x_i \nonumber \\
\Sigma_a(x) &= \Sigma_{a,i}\;, \qquad x_{i-1} \leq x \leq x_i \nonumber \\
h_i &\equiv x_{i} - x{i-1} \nonumber \\
\phi(x_i) &= \phi_i \nonumber \\
S(x_i) &= S_i \nonumber 
\end{align}
%
\begin{figure}[h!]
\includegraphics[height=2.5in]{FVM-DE}
\end{figure}

We further assume that the fluxes and sources are constant over the interval centered around $x_i$:
%
\begin{align}
\phi(x) &= \phi_i \qquad \text{for } \bigl(x_i - \frac{h_i}{2}\bigr) \leq x \leq \bigl(x_i + \frac{h_{i+1}}{2}\bigr) \nonumber \\
S(x) &= S_i \qquad \text{for } \bigl(x_i - \frac{h_i}{2}\bigr) \leq x \leq \bigl(x_i + \frac{h_{i+1}}{2}\bigr) \nonumber 
\end{align}

Now, we integrate the differential equation over each cell, $\bigl(x_i - \frac{h_i}{2}\bigr) \leq x \leq \bigl(x_i + \frac{h_{i+1}}{2}\bigr)$:
%
\[\int_{(x_i - \frac{h_i}{2})}^{(x_i + \frac{h_{i+1}}{2})} \biggl(  -\frac{d}{dx}D(x)\frac{d \phi(x)}{dx}\biggr) dx + \int_{(x_i - \frac{h_i}{2})}^{(x_i + \frac{h_{i+1}}{2})} \Sigma_a(x) \phi(x) dx = \int_{(x_i - \frac{h_i}{2})}^{(x_i + \frac{h_{i+1}}{2})} S(x) dx\]

Term by term:
\begin{align}
\int_{(x_i - \frac{h_i}{2})}^{(x_i + \frac{h_{i+1}}{2})} S(x) dx &\approx S_i \bigl(\frac{h_i + h_{i+1}}{2}\bigr) \nonumber \\
%
\int_{(x_i - \frac{h_i}{2})}^{(x_i + \frac{h_{i+1}}{2})} \Sigma_a(x) \phi(x) dx &= 
\int_{(x_i - \frac{h_i}{2})}^{(x_i)} \Sigma_a(x) \phi(x) dx + \int_{(x_i)}^{(x_i + \frac{h_{i+1}}{2})} \Sigma_a(x) \phi(x) dx \nonumber\\&=
\biggl(\frac{\Sigma_{a,i}h_i + \Sigma_{a,i+1}h_{i+1}}{2} \biggr)\phi_i\nonumber \\
%
 \int_{(x_i - \frac{h_i}{2})}^{(x_i + \frac{h_{i+1}}{2})} \biggl(  -\frac{d}{dx}D(x)\frac{d \phi(x)}{dx}\biggr) dx &=
-\biggl[D(x)\frac{d \phi(x)}{dx} \biggr]_{(x_i - \frac{h_i}{2})}^{(x_i + \frac{h_{i+1}}{2})} \nonumber \\
%
-D(x)\frac{d \phi(x)}{dx}\big|_{(x_i + \frac{h_{i+1}}{2})} &\cong -D_{i+1}\biggl(\frac{\phi_{i+1} - \phi_i}{h_{i+1}}\biggr) \nonumber \\
%
-D(x)\frac{d \phi(x)}{dx}\big|_{(x_i - \frac{h_i}{2})} &\cong -D_{i}\biggl(\frac{\phi_{i} - \phi_{i-1}}{h_{i}}\biggr) \nonumber
\end{align}

Collecting all of the terms:
%
\begin{equation}
-D_{i+1}\biggl(\frac{\phi_{i+1} - \phi_i}{h_{i+1}}\biggr) + D_{i}\biggl(\frac{\phi_{i} - \phi_{i-1}}{h_{i}}\biggr) + \biggl(\frac{\Sigma_{a,i}h_i + \Sigma_{a,i+1}h_{i+1}}{2} \biggr)\phi_i =   S_i \bigl(\frac{h_i + h_{i+1}}{2}\bigr) \nonumber
\end{equation}

We can express this in matrix form, but we'll use some abbreviations to make it more compact:
\begin{align}
h_{ii} &= \frac{h_i + h_{i+1}}{2} \nonumber \\
%
\Sigma_{a,ii} = \frac{\Sigma_{a,i}h_i + \Sigma_{a,i+1}h_{i+1}}{h_i + h_{i+1}} \nonumber \\
\end{align}
Then
%
\[a_{i,i-1} \phi_{i-1} + a_{i,i}\phi_[ + a_{i, i+1} \phi_{i+1} = S_i \qquad \text{for } i = 1, 2, \dots, n-1 \]
%
where
%
\begin{align}
a_{i,i-1} &= \frac{-D_i}{h_i h_{ii}} \nonumber \\
a_{i,i-1} &= \frac{D_i}{h_i h_{ii}} + \frac{D_{i+1}}{h_{i+1} h_{ii}} +\Sigma_{a,ii} \nonumber \\
a_{i,i+1} &= \frac{-D_{i+1}}{h_{i+1} h_{ii}} \nonumber
\end{align}

Now we have a set of $n-1$ linear algebraic equations with $n+1$ unknowns. Next up: boundary conditions.


%--------------------------------------------------------------------
%--------------------------------------------------------------------
%\bibliographystyle{plain}
%\bibliography{LinearSolns} 

\end{document}